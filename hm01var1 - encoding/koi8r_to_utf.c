#include <stdio.h>
#include <stdlib.h>

int koi8r_to_utf(FILE *currentFile, FILE *resultFile) {

	int symbol;
	int highByte;
	int lowByte;

	int symbolsTable[66][2] = {
		{0x410, 0xE1}, //А
		{0x411, 0xE2}, //Б
		{0x412, 0xF7}, //В
		{0x413, 0xE7}, //Г
		{0x414, 0xE4}, //Д
		{0x415, 0xE5}, //Е
		{0x401, 0xB3}, //Ё
		{0x416, 0xF6}, //Ж
		{0x417, 0xFA}, //З
		{0x418, 0xE9}, //И
		{0x419, 0xEA}, //Й
		{0x41A, 0xEB}, //К
		{0x41B, 0xEC}, //Л
		{0x41C, 0xED}, //М
		{0x41D, 0xEE}, //Н
		{0x41E, 0xEF}, //О
		{0x41F, 0xF0}, //П
		{0x420, 0xF2}, //Р
		{0x421, 0xF3}, //С
		{0x422, 0xF4}, //Т
		{0x423, 0xF5}, //У
		{0x424, 0xE6}, //Ф
		{0x425, 0xE8}, //Х
		{0x426, 0xE3}, //Ц
		{0x427, 0xFE}, //Ч
		{0x428, 0xFB}, //Ш
		{0x429, 0xFD}, //Щ
		{0x42A, 0xFF}, //Ъ
		{0x42B, 0xF9}, //Ы
		{0x42C, 0xF8}, //Ь
		{0x42D, 0xFC}, //Э
		{0x42E, 0xE0}, //Ю
		{0x42F, 0xF1}, //Я
		{0x430, 0xC1}, //а
		{0x431, 0xC2}, //б
		{0x432, 0xD7}, //в
		{0x433, 0xC7}, //г
		{0x434, 0xC4}, //д
		{0x435, 0xC5}, //е
		{0x451, 0xA3}, //ё
		{0x436, 0xD6}, //ж
		{0x437, 0xDA}, //з
		{0x438, 0xC9}, //и
		{0x439, 0xCA}, //й
		{0x43A, 0xCB}, //к
		{0x43B, 0xCC}, //л
		{0x43C, 0xCD}, //м
		{0x43D, 0xCE}, //н
		{0x43E, 0xCF}, //о
		{0x43F, 0xD0}, //п
		{0x440, 0xD2}, //р
		{0x441, 0xD3}, //с
		{0x442, 0xD4}, //т
		{0x443, 0xD5}, //у
		{0x444, 0xC6}, //ф
		{0x445, 0xC8}, //х
		{0x446, 0xC3}, //ц
		{0x447, 0xDE}, //ч
		{0x448, 0xDB}, //ш
		{0x449, 0xDD}, //щ
		{0x44A, 0xDF}, //ъ
		{0x44B, 0xD9}, //ы
		{0x44C, 0xD8}, //ь
		{0x44D, 0xDC}, //э
		{0x44E, 0xC0}, //ю
		{0x44F, 0xD1}  //я
	};

	while((symbol = getc(currentFile)) != EOF){
		if (symbol > 0xA2 && symbol < 0x100) { // если символ относится к кириллице, то преобразуем

			for (int i = 0; i < 67; i++) {
				if (symbolsTable[i][1] == symbol) {
					symbol = symbolsTable[i][0];
					break;
				}
			}

			highByte = symbol >> 6;			// вычленяем 5 старших битов
			highByte = highByte | 0xC0;		// устанавливаем старшие разряды в 110
			fputc(highByte, resultFile);

			lowByte = symbol & 0x3F;		// обнуляем все биты старшего байта и выставляем 10 в старших битах младшего байта
			lowByte = lowByte | 0x80;
			symbol = highByte + lowByte;	// собираем младший и старщий байты
			fputc(lowByte, resultFile);
		} else
			fputc(symbol, resultFile);		// если символ не кириллический, то просто переносим
	}

	return 0;
}

